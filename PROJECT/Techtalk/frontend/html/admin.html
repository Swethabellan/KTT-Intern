<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
      display: flex;
    }

    /* Sidebar */
    .sidebar {
      background: #1c1d1e;
      color: white;
      width: 250px;
      min-height: 100vh;
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 2rem;
    }

    .sidebar-header .material-icons {
      margin-right: 0.5rem;
    }

    .sidebar-link {
      color: white;
      text-decoration: none;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      padding: 0.5rem;
      border-radius: 5px;
    }

    .sidebar-link .material-icons {
      margin-right: 0.5rem;
    }

    .sidebar-link:hover {
      background: #2b6cb0;
    }

    .logout-btn {
      background: #1c1b1b;
      color: white;
      border: none;
      padding: 0.5rem;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .logout-btn .material-icons {
      margin-right: 0.5rem;
    }

    .logout-btn:hover {
      background: #c53030;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 2rem;
    }

    .header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .header h1 {
      font-size: 2rem;
      color: #2d3748;
      margin-bottom: 0.5rem;
    }

    .header hr {
      border: 0;
      border-top: 2px solid #e2e8f0;
      margin: 0.5rem 0;
    }

    .header h2 {
      font-size: 1.5rem;
      color: #4a5568;
    }

    .error {
      color: #dc2626;
      font-size: 0.9rem;
      margin-bottom: 1rem;
      min-height: 1.2rem;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .tab {
      padding: 0.5rem 1rem;
      background: #e2e8f0;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .tab:hover,
    .tab.active {
      background: #2b6cb0;
      color: white;
    }

    /* Stats */
    .stats-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 1.5rem;
    }

    .stat-card {
      background: white;
      padding: 0;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      flex: 1 1 150px;
      text-align: center;
      cursor: pointer;
      transition: background 0.3s;
    }

    .stat-card:hover {
      background: #f0f4f8;
    }

    .stat-card h3 {
      font-size: 1.1rem;
      color: #4a5568;
      margin-bottom: 0.5rem;
    }

    .stat-card p {
      font-size: 1.5rem;
      color: #2d3748;
    }

    /* Table */
    .table-container {
      background: white;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 1rem;
    }

    .table-container h3 {
      font-size: 1.2rem;
      color: #4a5568;
      margin-bottom: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }

    th {
      background: #f0f4f8;
      color: #4a5568;
      font-weight: 600;
      cursor: pointer;
    }

    th:hover {
      background: #e2e8f0;
    }

    .toggle-btn,
    .question-toggle-btn,
    .answer-toggle-btn {
      background: #1c1b1b;
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 0.5rem;
    }

    .toggle-btn:hover,
    .question-toggle-btn:hover,
    .answer-toggle-btn:hover {
      background: #3182ce;
    }

    .details {
      margin: 1rem 0;
      padding: 1rem;
      background: #f9fafb;
      border-radius: 5px;
    }

    .answer {
      margin: 0.5rem 0;
      padding: 0.5rem;
      border-left: 3px solid #2b6cb0;
    }

    tr.inactive {
      background-color: #f9f9f9;
      opacity: 0.7;
    }

    .answer.inactive {
      background-color: #f8d7da;
      opacity: 0.7;
    }

    .correct-btn {
      background: #28a745;
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 0.5rem;
    }

    .correct-btn:hover {
      background: #218838;
    }

    .checkmark {
      color: #28a745;
      font-weight: bold;
      margin-left: 0.5rem;
    }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <span class="material-icons">forum</span>
      <span>TechTalk</span>
    </div>
    <a href="./admin.html" id="adminLink" class="sidebar-link">
      <span class="material-icons">admin_panel_settings</span> Admin Dashboard
    </a>
    <button id="logoutBtn" class="logout-btn">
      <span class="material-icons">logout</span> Logout
    </button>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <h1>TECH TALK</h1>
      <hr>
      <h2>Admin Dashboard</h2>
    </div>
    <div id="error-message" class="error"></div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-tab="questions">Questions</div>
      <div class="tab" data-tab="users">Users</div>
    </div>

    <!-- Stats -->
    <div class="stats-container">
      <div class="stat-card" data-filter="all">
        <h3>Total Questions</h3>
        <p id="totalQuestions">0</p>
      </div>
      <div class="stat-card" data-filter="answered">
        <h3>Answered</h3>
        <p id="answeredQuestions">0</p>
      </div>
      <div class="stat-card" data-filter="unanswered">
        <h3>Unanswered</h3>
        <p id="unansweredQuestions">0</p>
      </div>
      <div class="stat-card" data-filter="activeusers">
        <h3>Active Users</h3>
        <p id="activeUsers">0</p>
      </div>
    </div>

    <!-- Questions Tab -->
    <div id="questions-tab" class="tab-content">
      <div class="table-container">
        <h3>All Questions</h3>
        <table>
          <thead>
            <tr>
              <th data-sort="id">ID</th>
              <th data-sort="title">Question title</th>
              <th data-sort="description">Questions</th>
              <th data-sort="username">Asked By</th>
              <th data-sort="answerCount">Answers</th>
              <th data-sort="createdAt">Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="questionsTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Users Tab -->
    <div id="users-tab" class="tab-content" style="display: none;">
      <div class="table-container">
        <h3>Users</h3>
        <table>
          <thead>
            <tr>
              <th data-sort="id">ID</th>
              <th data-sort="username">Username</th>
              <th data-sort="email">Email</th>
              <th data-sort="role">Role</th>
              <th data-sort="isActive">Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    function showError(message) {
      const errorMessage = document.getElementById('error-message');
      errorMessage.textContent = message;
    }

    // function switchTab(tabName) {
    //   document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    //   document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
    //   document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
    //   document.querySelector(`#${tabName}-tab`).style.display = 'block';

    //   if (['answered', 'unanswered', 'all'].includes(tabName)) fetchQuestions(tabName);
    //   else if (tabName === 'users') fetchUsers();
    // }
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');

      if (['all', 'answered', 'unanswered'].includes(tabName)) {
        document.querySelector('.tab[data-tab="questions"]').classList.add('active');
        document.querySelector('#questions-tab').style.display = 'block';
        fetchQuestions(tabName);
      } else if (tabName === 'activeusers') {
        document.querySelector('.tab[data-tab="users"]').classList.add('active');
        document.querySelector('#users-tab').style.display = 'block';
        fetchUsers('activeusers');
      } else {
        document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
        document.querySelector(`#${tabName}-tab`).style.display = 'block';

        if (tabName === 'users') {
          fetchUsers();
        } else if (tabName === 'questions') {
          fetchQuestions('all');
        }
      }
    }

    let currentQuestionSort = { sortBy: 'createdAt', order: 'ASC' };

    async function fetchQuestions(filter) {
      const token = localStorage.getItem('token');
      if (!token) return;

      try {
        const url = `http://127.0.0.1:3000/api/questions?filter=${filter}&sortBy=${currentQuestionSort.sortBy}&order=${currentQuestionSort.order}`;
        const questionsResponse = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        let questions = await questionsResponse.json();
        if (questionsResponse.ok) {
          if (filter == 'answered') {
            questions = questions.filter(q => q.Answers?.length > 0);
          } else if (filter == 'unanswered') {
            questions = questions.filter(q => !q.Answers || q.Answers.length === 0);
          } else if (filter == 'activeusers') {
            users = users.filter(u => u.isActive === true);
          }
          const tableBody = document.getElementById('questionsTable');
          tableBody.innerHTML = '';
          questions.forEach(q => {
            const row = document.createElement('tr');
            if (!q.isActive) {
              row.classList.add('inactive');
            }
            row.innerHTML = `
              <td>${q.id}</td>
              <td>${q.title}</td>
              <td>${q.description}</td>
              <td>${q.User?.username || 'Unknown'}</td>
              <td>${q.Answers?.length || 0}</td>
              <td>${new Date(q.createdAt).toLocaleDateString()}</td>
              <td>
                <button class="question-toggle-btn" data-id="${q.id}" data-type="question">${q.isActive ? 'Deactivate' : 'Activate'}</button>
                <button class="toggle-details" data-id="${q.id}">Answers</button>

              </td>
            `;
            tableBody.appendChild(row);

            const detailsRow = document.createElement('tr');
            detailsRow.classList.add('details-row');
            detailsRow.style.display = 'none';
            detailsRow.innerHTML = `
              <td colspan="7">
                <div class="details">
                  <h4>Answers:</h4>
                  ${q.Answers && q.Answers.length > 0 ? q.Answers.map(a => `
                    <div class="answer">
                      <p>${a.content} (Posted on ${new Date(a.createdAt).toLocaleDateString()})${a.isCorrect ? '<span class="checkmark">✔</span>' : ''}</p>
                      <button class="answer-toggle-btn" data-id="${a.id}" data-type="answer">${a.isActive ? 'Deactivate' : 'Activate'}</button>
                      <button class="correct-btn" data-id="${a.id}">${a.isCorrect ? 'Unmark Correct' : 'Mark Correct'}</button>
                    </div>
                  `).join('') : '<p>No answers yet.</p>'}
                </div>
              </td>
            `;
            tableBody.appendChild(detailsRow);
          });

          document.querySelectorAll('.question-toggle-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
              const id = btn.getAttribute('data-id');
              const type = btn.getAttribute('data-type');
              const endpoint = `http://127.0.0.1:3000/api/questions/${id}/toggle-active`;

              if (confirm(`${btn.textContent} this ${type}?`)) {
                try {
                  const toggleResponse = await fetch(endpoint, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                  });
                  if (!toggleResponse.ok) {
                    const errorData = await toggleResponse.json();
                    throw new Error(`Failed to toggle ${type} status: ${errorData.message || toggleResponse.statusText}`);
                  }
                  const result = await toggleResponse.json();
                  btn.textContent = result.isActive ? 'Deactivate' : 'Activate';
                  const row = btn.closest('tr');
                  if (result.isActive) {
                    row.classList.remove('inactive');
                  } else {
                    row.classList.add('inactive');
                  }
                  fetchStats();
                  fetchQuestions(filter);
                } catch (error) {
                  console.error(`Error toggling ${type}:`, error);
                  showError(`Failed to toggle ${type} status: ${error.message}`);
                }
              }
            });
          });

          document.querySelectorAll('.answer-toggle-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
              const id = btn.getAttribute('data-id');
              const type = btn.getAttribute('data-type');
              const endpoint = `http://127.0.0.1:3000/api/questions/answers/${id}/toggle-active`;

              console.log(`Attempting to toggle answer ID: ${id}, Type: ${type}, Endpoint: ${endpoint}`); // Debug log

              if (confirm(`${btn.textContent} this ${type}?`)) {
                try {
                  console.log('Token:', token);
                  const toggleResponse = await fetch(endpoint, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                  });
                  console.log('Response Status:', toggleResponse.status); // Debug log
                  if (!toggleResponse.ok) {
                    const errorData = await toggleResponse.json();
                    console.error('Error Response:', errorData); // Debug log
                    throw new Error(`Failed to toggle ${type} status: ${errorData.message || toggleResponse.statusText}`);
                  }
                  const result = await toggleResponse.json();
                  console.log('Toggle Result:', result); // Debug log
                  btn.textContent = result.isActive ? 'Deactivate' : 'Activate';
                  const answerDiv = btn.closest('.answer');
                  if (result.isActive) {
                    answerDiv.classList.remove('inactive');
                  } else {
                    answerDiv.classList.add('inactive');
                  }
                  fetchQuestions(filter);
                } catch (error) {
                  console.error(`Error toggling ${type}:`, error);
                  showError(`Failed to toggle ${type} status: ${error.message} (Status: ${toggleResponse?.status || 'N/A'})`);
                }
              }
            });
          });
                  
          document.querySelectorAll('.toggle-details').forEach(btn => {
            btn.addEventListener('click', () => {
              const detailsRow = btn.closest('tr').nextElementSibling;
              detailsRow.style.display = detailsRow.style.display === 'none' ? 'table-row' : 'none';
              btn.textContent = detailsRow.style.display === 'none' ? 'Answers' : 'Hide';
            });
          });


          document.querySelectorAll('.correct-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
              const id = btn.getAttribute('data-id');
              if (confirm(`${btn.textContent} this answer?`)) {
                try {
                  const response = await fetch(`http://127.0.0.1:3000/api/questions/answers/${id}/mark-correct`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                  });
                  if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Failed to mark answer as correct: ${errorData.message || response.statusText}`);
                  }
                  const result = await response.json();
                  btn.textContent = result.isCorrect ? 'Unmark Correct' : 'Mark Correct';
                  const answerDiv = btn.closest('.answer');
                  const paragraph = answerDiv.querySelector('p');
                  let checkmark = paragraph.querySelector('.checkmark');
                  if (result.isCorrect && !checkmark) {
                    checkmark = document.createElement('span');
                    checkmark.className = 'checkmark';
                    checkmark.textContent = '✔';
                    paragraph.appendChild(checkmark);
                  } else if (!result.isCorrect && checkmark) {
                    checkmark.remove();
                  }
                  fetchQuestions(filter);
                } catch (error) {
                  console.error('Error marking answer as correct:', error);
                  showError(`Failed to mark answer as correct: ${error.message}`);
                }
              }
            });
          });

          const tableHeader = document.querySelector('.table-container h3');
          tableHeader.textContent = filter === 'all' ? 'All Questions' : filter === 'answered' ? 'Answered Questions' : 'Unanswered Questions';
        } else {
          showError('Failed to load questions.');
        }
      } catch (error) {
        console.error('Error fetching questions:', error);
        showError('Error loading questions.');
      }
    }

    let currentUserSort = { sortBy: 'createdAt', order: 'ASC' };
    async function fetchUsers(filter) {
      const token = localStorage.getItem('token');
      if (!token) return;

      try {
        const usersResponse = await fetch(`http://127.0.0.1:3000/api/users/users?sortBy=${currentUserSort.sortBy}&order=${currentUserSort.order}&filter=${filter}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        let users = await usersResponse.json();
        if (usersResponse.ok) {

          if (filter === 'activeusers') {
            users = users.filter(u => u.isActive === true || u.isActive === 'true');
          }
          const tableBody = document.getElementById('usersTable');
          tableBody.innerHTML = '';
          users.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${user.id}</td>
              <td>${user.username}</td>
              <td>${user.email}</td>
              <td>${user.role}</td>
              <td>${user.isActive ? 'Active' : 'Inactive'}</td>
              <td>
                <button class="toggle-btn" data-id="${user.id}" data-type="user">${user.isActive ? 'Deactivate' : 'Activate'}</button>
              </td>
            `;
            tableBody.appendChild(row);
          });

          document.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
              const id = btn.getAttribute('data-id');
              const type = btn.getAttribute('data-type');
              const endpoint = `http://127.0.0.1:3000/api/users/${id}/toggle-active`; // Adjusted endpoint
              if (confirm(`${btn.textContent} this ${type}?`)) {
                try {
                  const toggleResponse = await fetch(endpoint, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                  });
                  if (!toggleResponse.ok) {
                    const errorData = await toggleResponse.json();
                    throw new Error(`Failed to toggle user status: ${errorData.message || toggleResponse.statusText}`);
                  }
                  const result = await toggleResponse.json();
                  btn.textContent = result.isActive ? 'Deactivate' : 'Activate';
                  btn.closest('tr').children[4].textContent = result.isActive ? 'Active' : 'Inactive';
                  fetchStats();
                  fetchUsers(filter);
                } catch (error) {
                  console.error('Error toggling user:', error);
                  showError(`Failed to toggle user status: ${error.message}`);
                }
              }
            });
          });
          const tableHeader = document.querySelector('#users-tab .table-container h3');
          tableHeader.textContent = filter === 'activeusers' ? 'Active Users' : 'Users';
        } else {
          showError('Failed to load users.');
        }
      } catch (error) {
        console.error('Error fetching users:', error);
        showError('Error loading users.');
      }
    }

    async function fetchStats() {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          throw new Error('No token found. Please log in.');
        }
        const response = await fetch('http://127.0.0.1:3000/api/users/stats', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token} `
          }
        });
        if (response.ok) {

          const data = await response.json();
          const questionsResponse = await fetch('http://127.0.0.1:3000/api/questions?filter=all', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!questionsResponse.ok) {
            const errorData = await questionsResponse.json().catch(() => ({}));
            console.error('Fetch questions failed:', questionsResponse.status, errorData);
            showError(`Failed to fetch questions: ${errorData.message || questionsResponse.statusText || 'Unknown error'}`);
            return;
          }
          const questions = await questionsResponse.json();
          const total = questions.length;
          const answered = questions.filter(q => q.Answers?.length > 0).length;
          const unanswered = total - answered;
          document.getElementById('totalQuestions').textContent = data.total || 0;
          document.getElementById('answeredQuestions').textContent = data.answered || 0;
          document.getElementById('unansweredQuestions').textContent = data.unanswered || 0;
          document.getElementById('activeUsers').textContent = data.activeUsers || 0;
        } else {
          const errorData = await response.json().catch(() => ({}));
          console.error('Fetch stats failed:', response.status, errorData);
          showError(`Failed to fetch stats: ${errorData.message || response.statusText || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Error fetching stats:', error.message);
        showError(`Error fetching stats: ${error.message}`);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const token = localStorage.getItem('token');
      const role = localStorage.getItem('role');
      console.log('Token:', token);
      console.log('Role:', role);

      try {
        const profileResponse = await fetch('http://127.0.0.1:3000/api/users/profile', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const profileData = await profileResponse.json();
        console.log('Admin profile:', profileData);

        if (!profileResponse.ok || profileData.role !== 'admin') {
          showError('Admin access required. Redirecting to login...');
          // setTimeout(() => { window.location.href = 'login.html'; }, 2000);
          return;
        }

        document.getElementById('adminLink').style.display = 'flex';

        await fetchStats();
        await fetchQuestions('all');

        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.getAttribute('data-tab');
            switchTab(tabName);
          });
        });

        document.querySelectorAll('.stat-card').forEach(card => {
          card.addEventListener('click', () => {
            const filter = card.getAttribute('data-filter');
            if (filter) {
              switchTab(filter);
            }
          });
        });

        document.querySelectorAll('#questions-tab th[data-sort]').forEach(header => {
          header.addEventListener('click', () => {
            const sortBy = header.getAttribute('data-sort');
            currentQuestionSort.order = currentQuestionSort.sortBy === sortBy && currentQuestionSort.order === 'ASC' ? 'DESC' : 'ASC';
            currentQuestionSort.sortBy = sortBy;
            fetchQuestions(document.querySelector('.table-container h3').textContent.includes('All') ? 'all' : document.querySelector('.table-container h3').textContent.includes('Answered') ? 'answered' : 'unanswered');
          });
        });

        document.querySelectorAll('#users-tab th[data-sort]').forEach(header => {
          header.addEventListener('click', () => {
            const sortBy = header.getAttribute('data-sort');
            currentUserSort.order = currentUserSort.sortBy === sortBy && currentUserSort.order === 'ASC' ? 'DESC' : 'ASC';
            currentUserSort.sortBy = sortBy;
            fetchUsers();
          });
        });
      } catch (error) {
        console.error('Admin error:', error);
        showError('Error loading dashboard. Redirecting to login...');
        // setTimeout(() => { window.location.href = 'login.html'; }, 2000);
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    });
  </script>
</body>

</html>